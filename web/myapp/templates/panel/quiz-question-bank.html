{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Quiz Question Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/quiz-question-bank.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="quiz-question-bank-container">

  <!-- Navigation Sidebar -->
  <div class="exam-admin-navigation">
    <div class="logo-container"></div>
    <div class="nav-buttons-container">
      <a href="{% url 'admin_dashboard' %}" style="text-decoration: none;"><div class="nav-button" style="border:  #854BAB 1px solid;">
        <img src="{% static 'public3/external/dashboardlayout2136-pwh-200w.png' %}" alt="Dashboard" class="nav-icon">
        <span>Dashboard</span>
      </div></a>
      
      <a href="{% url 'admin_students' %}" style="text-decoration: none;"><div class="nav-button" style="border:  #854BAB 1px solid;">
        <img src="{% static 'public3/external/studentmale2134-uejm-200h.png' %}" alt="Students" class="nav-icon">
        <span>Students</span>
      </div></a>
      
      <a href="{% url 'admin_attendance' %}" style="text-decoration: none;"><div class="nav-button" style="border:  #854BAB 1px solid;">
        <img src="{% static 'public3/external/attendance7018-1v4-200h.png' %}" alt="Attendance" class="nav-icon">
        <span>Attendance</span>
      </div></a>
      
      <a href="{% url 'admin_quiz' %}" style="text-decoration: none;"><div class="nav-button active" style="border:  #854BAB 1px solid;">
        <img src="{% static 'public3/external/quiz2137-2g3-200h.png' %}" alt="Quiz" class="nav-icon">
        <span>Quiz</span>
      </div></a>
      
      <a href="{% url 'admin_exam' %}" style="text-decoration: none;"><div class="nav-button" style="border:  #854BAB 1px solid;">
        <img src="{% static 'public3/external/exam2137-tdwn-200w.png' %}" alt="Exam" class="nav-icon">
        <span>Exam</span>
      </div></a>
    </div>
  </div>
    <div class="main-content">
      <header class="header">
        <div class="header-title">
          <img src="{% static 'public3/external/quiz2137-3uc7-200h.png' %}" alt="Quiz Icon">
          <h1>Quiz Question Bank</h1>
        </div>
            <!-- Replace the existing user-profile div with this: -->
        <div class="user-profile">
        <button class="account-button" onclick="toggleAccountMenu()">
            <img src="{% static 'public3/external/testaccount1812-au0p-200w.png' %}" alt="User">
                </button>
                
                <!-- Account Dropdown Menu -->
                <div id="accountMenu" class="account-menu">
                  <a href="{% url 'logout' %}">Logout</a>
                </div>
              </div>
      </header>

      <div class="content-area">
        <div class="quiz-info">
          <div class="quiz-title-section">
            <form id="quizForm" method="POST" action="{% url 'quiz_question_bank' %}">
              {% csrf_token %}
              <div class="form-group">
                <label for="quizTitle">Quiz Title:</label>
                <input type="text" id="quizTitle" name="title" placeholder="Enter Quiz Title" class="title-input" value="{{ form.title.value|default:'' }}" required>
              </div>
              <div class="form-group">
                <label for="quizSubject">Subject:</label>
                <select id="quizSubject" name="subject" required>
                  <option value="">Select Subject</option>
                  {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if form.subject.value == subject.id %}selected{% endif %}>{{ subject.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="quizDate">Due Date:</label>
                <input type="datetime-local" id="quizDate" name="due_date" value="{{ form.due_date.value|default:'' }}" required>
              </div>
              <div class="form-group">
                <label for="timeLimit">Time Limit (minutes):</label>
                <input type="number" id="timeLimit" name="time_limit" min="1" value="{{ form.time_limit.value|default:'30' }}" required>
              </div>
              <div class="form-group">
                <label for="quizDescription">Description:</label>
                <textarea id="quizDescription" name="description" placeholder="Enter Quiz Description" class="description-input">{{ form.description.value|default:'' }}</textarea>
              </div>
              <input type="hidden" name="is_published" value="true">
              <input type="hidden" name="is_active" value="true">
              <input type="hidden" name="questions" id="questionsData">
            </form>
          </div>
          <div class="quiz-stats">
            <div class="stat-item">
              <span class="stat-label">Total Questions:</span>
              <span class="stat-value" id="totalQuestions">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Points:</span>
              <span class="stat-value" id="totalPoints">0</span>
            </div>
          </div>
        </div>

        <div class="question-controls">
          <button class="add-question-btn" id="addMultipleChoiceBtn">
            <i class="fas fa-list-ul"></i>
            <span>Multiple Choice</span>
          </button>
          <button class="add-question-btn" id="addShortAnswerBtn">
            <i class="fas fa-align-left"></i>
            <span>Short Answer</span>
          </button>
        </div>

        <div class="questions-container" id="questionsContainer">
          {% if quiz %}
            {% for question in quiz.questions.all %}
              <div class="question-card" data-question-id="{{ question.id }}" draggable="true">
                <div class="question-header">
                  <div class="question-handle">
                    <i class="fas fa-grip-vertical"></i>
                  </div>
                  <h3 class="question-label">Question <span class="question-number">{{ forloop.counter }}</span></h3>
                  <div class="question-actions">
                    <button class="copy-question" title="Copy Question">
                      <i class="fas fa-copy"></i>
                    </button>
                    <button class="delete-question" title="Delete Question">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="question-body">
                  <div class="question-type-selector">
                    <select class="question-type" onchange="handleQuestionTypeChange(this)">
                      <option value="multiple_choice" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>Multiple Choice</option>
                      <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>Short Answer</option>
                    </select>
                    <label class="required-toggle">
                      <input type="checkbox" class="required-checkbox" {% if question.is_required %}checked{% endif %}>
                      Required
                    </label>
                  </div>
                  <textarea class="question-text" placeholder="Enter your question here">{{ question.content }}</textarea>
                  {% if question.question_type == 'multiple_choice' %}
                    <div class="options-container">
                      {% for choice in question.choices.all %}
                        <div class="option">
                          <input type="radio" name="correctOption_{{ question.id }}" {% if choice.is_correct %}checked{% endif %}>
                          <input type="text" placeholder="Option {{ forloop.counter }}" value="{{ choice.text }}">
                          <button class="delete-option"><i class="fas fa-times"></i></button>
                        </div>
                      {% endfor %}
                    </div>
                    <button class="add-option"><i class="fas fa-plus"></i> Add Option</button>
                  {% else %}
                    <div class="answer-container">
                      <label>Correct Answer:</label>
                      <input type="text" class="correct-answer" placeholder="Enter correct answer">
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <div class="navigation-controls">
          <button class="nav-btn" id="prevPageBtn">Cancel</button>
          <button class="nav-btn primary" id="saveQuizBtn" type="button">Save Quiz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Template (Hidden) -->
  <div class="question-template" id="multipleChoiceTemplate" style="display: none;">
    <div class="question-card">
      <div class="question-header">
        <h3 class="question-label">Question <span class="question-number">1</span></h3>
        <select class="question-type" onchange="handleQuestionTypeChange(this)">
          <option value="multiple_choice">Multiple Choice</option>
          <option value="short_answer">Short Answer</option>
        </select>
        <button class="delete-question">×</button>
      </div>
      <div class="question-body">
        <textarea class="question-text" placeholder="Enter your question here"></textarea>
        <div class="options-container">
          <div class="option">
            <input type="radio" name="correctOption" class="correct-option">
            <input type="text" placeholder="Option 1" class="option-text">
            <button class="delete-option">×</button>
          </div>
        </div>
        <button class="add-option">+ Add Option</button>
      </div>
    </div>
  </div>

  <div class="question-template" id="shortAnswerTemplate" style="display: none;">
    <div class="question-card">
      <div class="question-header">
        <h3 class="question-label">Question <span class="question-number">1</span></h3>
        <select class="question-type" onchange="handleQuestionTypeChange(this)">
          <option value="short_answer">Short Answer</option>
          <option value="multiple_choice">Multiple Choice</option>
        </select>
        <button class="delete-question">×</button>
      </div>
      <div class="question-body">
        <textarea class="question-text" placeholder="Enter your question here"></textarea>
        <div class="answer-container">
          <label>Correct Answer:</label>
          <input type="text" class="correct-answer" placeholder="Enter correct answer">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Sortable for drag and drop
      const questionsContainer = document.getElementById('questionsContainer');
      new Sortable(questionsContainer, {
        handle: '.question-handle',
        animation: 150,
        onEnd: function() {
          updateQuestionNumbers();
        }
      });

      // Question counter
      let questionCount = document.querySelectorAll('.question-card').length;

      // Add Multiple Choice Question
      document.getElementById('addMultipleChoiceBtn').addEventListener('click', function() {
        addQuestion('multiple_choice');
      });

      // Add Short Answer Question
      document.getElementById('addShortAnswerBtn').addEventListener('click', function() {
        addQuestion('short_answer');
      });

      // Cancel Button
      document.getElementById('prevPageBtn').addEventListener('click', function() {
        window.location.href = "{% url 'admin_quiz' %}";
      });

      // Save Quiz Button
      const saveQuizBtn = document.getElementById('saveQuizBtn');
      if (saveQuizBtn) {
        saveQuizBtn.addEventListener('click', function(e) {
          e.preventDefault();
          saveQuiz();
        });
      }

      // Function to handle question type change
      window.handleQuestionTypeChange = function(select) {
        const questionCard = select.closest('.question-card');
        const currentType = select.value;
        const questionText = questionCard.querySelector('.question-text').value;
        const isRequired = questionCard.querySelector('.required-checkbox').checked;
        
        if (currentType === 'multiple_choice') {
          convertToMultipleChoice(questionCard, questionText, isRequired);
        } else {
          convertToShortAnswer(questionCard, questionText, isRequired);
        }
      };

      // Function to add a new question
      function addQuestion(type) {
        const container = document.getElementById('questionsContainer');
        const questionNumber = container.querySelectorAll('.question-card').length + 1;
        
        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        questionCard.draggable = true;
        questionCard.dataset.questionId = Date.now();
        
        questionCard.innerHTML = `
            <div class="question-header">
                <div class="question-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <h3 class="question-label">Question <span class="question-number">${questionNumber}</span></h3>
                <div class="question-actions">
                    <button class="copy-question" title="Copy Question">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="delete-question" title="Delete Question">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="question-body">
                <div class="question-type-selector">
                    <select class="question-type" onchange="handleQuestionTypeChange(this)">
                        <option value="multiple_choice" ${type === 'multiple_choice' ? 'selected' : ''}>Multiple Choice</option>
                        <option value="short_answer" ${type === 'short_answer' ? 'selected' : ''}>Short Answer</option>
                    </select>
                    <label class="required-toggle">
                        <input type="checkbox" class="required-checkbox">
                        Required
                    </label>
                </div>
                <textarea class="question-text" placeholder="Enter your question here"></textarea>
                ${type === 'multiple_choice' ? `
                    <div class="options-container">
                        <div class="option">
                            <input type="radio" name="correctOption_${questionCard.dataset.questionId}" checked>
                            <input type="text" placeholder="Option 1">
                            <button class="delete-option"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <button class="add-option"><i class="fas fa-plus"></i> Add Option</button>
                ` : `
                    <div class="answer-container">
                        <label>Correct Answer:</label>
                        <input type="text" class="correct-answer" placeholder="Enter correct answer">
                    </div>
                `}
            </div>
        `;

        // Add event listeners
        questionCard.querySelector('.delete-question').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this question?')) {
                container.removeChild(questionCard);
                updateQuestionNumbers();
            }
        });

        questionCard.querySelector('.copy-question').addEventListener('click', function() {
            const clonedCard = questionCard.cloneNode(true);
            clonedCard.dataset.questionId = Date.now();
            container.appendChild(clonedCard);
            updateQuestionNumbers();
        });

        if (type === 'multiple_choice') {
            questionCard.querySelector('.add-option').addEventListener('click', addOption);
            const option = questionCard.querySelector('.option');
            option.querySelector('.delete-option').addEventListener('click', function() {
                if (document.querySelectorAll('.option').length > 1) {
                    option.parentNode.removeChild(option);
                }
            });

            const radioButtons = questionCard.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const options = questionCard.querySelectorAll('input[type="radio"]');
                    options.forEach(opt => {
                        if (opt !== this) {
                            opt.checked = false;
                        }
                    });
                });
            });
        }

        container.appendChild(questionCard);
        updateQuestionNumbers();
      }

      // Function to add a new option to multiple choice question
      function addOption() {
        const questionCard = this.closest('.question-card');
        const optionsContainer = questionCard.querySelector('.options-container');
        const optionCount = optionsContainer.querySelectorAll('.option').length + 1;
        
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        optionDiv.innerHTML = `
          <input type="radio" name="correctOption_${questionCard.dataset.questionId}">
          <input type="text" placeholder="Option ${optionCount}">
          <button class="delete-option"><i class="fas fa-times"></i></button>
        `;
        
        optionDiv.querySelector('.delete-option').addEventListener('click', function() {
          if (optionsContainer.querySelectorAll('.option').length > 1) {
            optionsContainer.removeChild(optionDiv);
          }
        });

        const radioButton = optionDiv.querySelector('input[type="radio"]');
        radioButton.addEventListener('change', function() {
          const options = optionsContainer.querySelectorAll('input[type="radio"]');
          options.forEach(opt => {
            if (opt !== this) {
              opt.checked = false;
            }
          });
        });
        
        optionsContainer.appendChild(optionDiv);
      }

      // Function to convert question to multiple choice
      function convertToMultipleChoice(questionCard, questionText, isRequired) {
        const questionBody = questionCard.querySelector('.question-body');
        questionBody.innerHTML = `
          <div class="question-type-selector">
            <select class="question-type" onchange="handleQuestionTypeChange(this)">
              <option value="multiple_choice" selected>Multiple Choice</option>
              <option value="short_answer">Short Answer</option>
            </select>
            <label class="required-toggle">
              <input type="checkbox" class="required-checkbox" ${isRequired ? 'checked' : ''}>
              Required
            </label>
          </div>
          <textarea class="question-text" placeholder="Enter your question here">${questionText}</textarea>
          <div class="options-container">
            <div class="option">
              <input type="radio" name="correctOption_${questionCard.dataset.questionId}" checked>
              <input type="text" placeholder="Option 1">
              <button class="delete-option"><i class="fas fa-times"></i></button>
            </div>
          </div>
          <button class="add-option"><i class="fas fa-plus"></i> Add Option</button>
        `;
        
        questionBody.querySelector('.add-option').addEventListener('click', addOption);
        questionBody.querySelector('.delete-option').addEventListener('click', function() {
          if (document.querySelectorAll('.option').length > 1) {
            this.parentNode.parentNode.removeChild(this.parentNode);
          }
        });

        const radioButton = questionBody.querySelector('input[type="radio"]');
        radioButton.addEventListener('change', function() {
          const options = questionBody.querySelectorAll('input[type="radio"]');
          options.forEach(opt => {
            if (opt !== this) {
              opt.checked = false;
            }
          });
        });
      }

      // Function to convert question to short answer
      function convertToShortAnswer(questionCard, questionText, isRequired) {
        const questionBody = questionCard.querySelector('.question-body');
        questionBody.innerHTML = `
          <div class="question-type-selector">
            <select class="question-type" onchange="handleQuestionTypeChange(this)">
              <option value="short_answer" selected>Short Answer</option>
              <option value="multiple_choice">Multiple Choice</option>
            </select>
            <label class="required-toggle">
              <input type="checkbox" class="required-checkbox" ${isRequired ? 'checked' : ''}>
              Required
            </label>
          </div>
          <textarea class="question-text" placeholder="Enter your question here">${questionText}</textarea>
          <div class="answer-container">
            <label>Correct Answer:</label>
            <input type="text" class="correct-answer" placeholder="Enter correct answer">
          </div>
        `;
      }

      // Function to update question numbers and count
      function updateQuestionNumbers() {
        const container = document.getElementById('questionsContainer');
        const questions = container.querySelectorAll('.question-card');
        let count = 0;
        
        questions.forEach((question, index) => {
            count++;
            question.querySelector('.question-number').textContent = count;
        });
        
        document.getElementById('totalQuestions').textContent = count;
      }

      // Function to collect question data
      function collectQuestionData() {
        const container = document.getElementById('questionsContainer');
        const questionElements = container.querySelectorAll('.question-card');
        const questions = [];
        
        for (let i = 0; i < questionElements.length; i++) {
            const element = questionElements[i];
            const questionText = element.querySelector('.question-text').value;
            
            if (!questionText) {
                alert(`Please enter a question for Question ${i + 1}`);
                return null;
            }
            
            const questionType = element.querySelector('.question-type').value;
            const isRequired = element.querySelector('.required-checkbox')?.checked || false;
            const points = 1;
            
            const questionData = {
                text: questionText,
                type: questionType,
                order: i,
                points: points,
                is_required: isRequired
            };
            
            if (questionType === 'multiple_choice') {
                const choices = [];
                const choiceElements = element.querySelectorAll('.option');
                let hasCorrectAnswer = false;
                
                for (let j = 0; j < choiceElements.length; j++) {
                    const choiceElement = choiceElements[j];
                    const choiceText = choiceElement.querySelector('input[type="text"]').value;
                    const radioButton = choiceElement.querySelector('input[type="radio"]');
                    const isCorrect = radioButton ? radioButton.checked : false;
                    
                    if (!choiceText) {
                        alert(`Please enter all choices for Question ${i + 1}`);
                        return null;
                    }
                    
                    if (isCorrect) {
                        hasCorrectAnswer = true;
                    }
                    
                    choices.push({
                        text: choiceText,
                        is_correct: isCorrect
                    });
                }
                
                if (!hasCorrectAnswer) {
                    alert(`Please select a correct answer for Question ${i + 1}`);
                    return null;
                }
                
                questionData.choices = choices;
            } else if (questionType === 'short_answer') {
                const correctAnswer = element.querySelector('.correct-answer')?.value;
                if (!correctAnswer) {
                    alert(`Please enter the correct answer for Question ${i + 1}`);
                    return null;
                }
                questionData.correct_answer = correctAnswer;
            }
            
            questions.push(questionData);
        }
        
        return questions;
      }

      // Function to save quiz
      function saveQuiz() {
        try {
            const questions = collectQuestionData();
            if (!questions) {
                return;
            }
            
            if (questions.length === 0) {
                alert('Please add at least one question to the quiz');
                return;
            }
            
            const quizTitle = document.getElementById('quizTitle').value;
            if (!quizTitle) {
                alert('Please enter a quiz title');
                return;
            }

            const subject = document.querySelector('select[name="subject"]').value;
            if (!subject) {
                alert('Please select a subject');
                return;
            }

            const dueDate = document.querySelector('input[name="due_date"]').value;
            if (!dueDate) {
                alert('Please set a due date');
                return;
            }

            const timeLimit = document.querySelector('input[name="time_limit"]').value;
            if (!timeLimit) {
                alert('Please set a time limit');
                return;
            }
            
            // Set the questions data in the hidden input
            document.getElementById('questionsData').value = JSON.stringify(questions);
            
            // Disable the save button to prevent double submission
            const saveButton = document.getElementById('saveQuizBtn');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Submit the form
            const form = document.getElementById('quizForm');
            if (form) {
                form.submit();
            } else {
                alert('Error: Form not found');
                saveButton.disabled = false;
                saveButton.innerHTML = 'Save Quiz';
            }
        } catch (error) {
            console.error('Error saving quiz:', error);
            alert('An error occurred while saving the quiz. Please try again.');
            const saveButton = document.getElementById('saveQuizBtn');
            saveButton.disabled = false;
            saveButton.innerHTML = 'Save Quiz';
        }
      }
    });
  </script>
            <script>
              // Toggle account menu
          function toggleAccountMenu() {
            const menu = document.getElementById('accountMenu');
            menu.classList.toggle('active');
          }
          
          // Close account menu when clicking outside
          document.addEventListener('click', function(event) {
            const accountMenu = document.getElementById('accountMenu');
            const accountButton = document.querySelector('.account-button');
            
            if (!accountButton.contains(event.target) && !accountMenu.contains(event.target)) {
              accountMenu.classList.remove('active');
            }
          });
            </script>
</body>
</html>